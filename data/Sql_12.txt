SELECT agency.n_agency, Coalesce(party.n_party_first, '') || ' ' || Coalesce(party.n_party_middle, '') || ' '
|| Coalesce(party.n_party_last, '') || CASE WHEN party.t_designation IS NULL OR party.t_designation = '' THEN '' ELSE ', '
|| party.t_designation END AS agent_name, party.i_party_number AS agentnumber, Upper(party.c_geo_state) AS st,
div.n_division AS n_division, div.i_party_number AS division_ Max(party.d_contract) AS d_contract, CASE WHEN
Upper(c_status) = 'CANCEL' THEN 'C' ELSE ' ' END AS c_status, CASE WHEN Upper(party.c_geo_state) IN ( 'IA', 'KS' )
AND Upper(div.n_division) IN ( 'IOWA WEST', 'METRO DIVISION' ) THEN 2 ELSE 1 END AS division_indicator, Sum(CASE WHEN
( factor.i_factor = 40 AND Upper(factor.c_factor_type) = 'FACTOR' ) THEN fact13.a_factor_value ELSE 0 END)
AS pccontestcredit, Sum(CASE WHEN ( factor.i_factor = 43 AND Upper(factor.c_factor_type) = 'FACTOR' ) THEN
fact13.a_factor_value ELSE 0 END) AS pcuars, Max(CASE WHEN ( fact6.i_factor = 27 AND Upper(fact6.c_factor_type)
= 'FACTOR' ) THEN Coalesce(fact6.a_factor, 0) ELSE 0 END) AS pcretention, Max(pm_tym.d_date) AS d_date FROM
pcrt_contest contest INNER JOIN pcrt_fact13 fact13 ON contest.i_contest_key = fact13.i_contest_key INNER JOIN
pcrt_subcontest psub ON psub.i_contest_number = contest.i_contest_number AND psub.i_subcontest_number = 22 INNER
JOIN pcrt_party party ON party.i_party_key = fact13.i_party_key AND Upper(party.n_party_role) IN ( 'AGENT', 'CROP AGENT',
'INTERN', 'RESERVE AGENT' ) AND Upper(party.c_geo_state) IN ( 'AZ', 'IA', 'KS', 'MN', 'NE', 'NM', 'SD', 'UT' ) AND
( party.d_cancel IS NULL OR YEAR(party.d_cancel) >= YEAR(pm_tym.d_date) ) AND party.d_contract < pm_tym.d_date INNER JOIN
pcrt_time pm_tym ON pm_tym.i_time_key = fact13.i_time_key AND Upper(pm_tym.f_report_monthly) = 'Y' AND pm_tym.d_date
BETWEEN contest.d_start AND contest.d_end LEFT OUTER JOIN (SELECT fact6.*, factor_prty.c_factor_type, factor_prty.i_factor
FROM pcrt_fact6 fact6 INNER JOIN pcrt_factor factor_prty ON fact6.i_factor_key = factor_prty.i_factor_key AND
factor_prty.i_factor = 27 AND Upper(factor_prty.c_factor_type) = 'FACTOR' INNER JOIN pcrt_time pm_tym ON pm_tym.i_time_key
= fact6.i_time_key AND Upper(pm_tym.f_report_monthly) = 'Y') fact6 ON fact6.i_party_number = party.i_party_number INNER
JOIN pcrt_agency agency ON agency.i_agency_party_key = fact13.i_agency_party_key INNER JOIN pcrt_division div ON
div.i_division_party_key = fact13.i_division_party_key INNER JOIN pcrt_factor factor ON factor.i_factor_key =
fact13.i_factor_key AND factor.i_factor IN ( 40, 43 ) AND Upper(factor.c_factor_type) = 'FACTOR' GROUP BY party.i_party_number,
Coalesce(party.n_party_first, '') || ' ' || Coalesce(party.n_party_middle, '') || ' ' || Coalesce(party.n_party_last, '') ||
CASE WHEN party.t_designation IS NULL OR party.t_designation = '' THEN '' ELSE ', ' || party.t_designation END,
Upper(party.c_geo_state), div.n_division, div.i_party_number, CASE WHEN Upper(c_status) = 'CANCEL' THEN 'C' ELSE ' '
END, CASE WHEN Upper(party.c_geo_state) IN ( 'IA', 'KS' ) AND Upper(div.n_division) IN ( 'IOWA WEST', 'METRO DIVISION' )
THEN 2 ELSE 1 END, agency.n_agency ORDER BY pccontestcredit desc, pcuars desc